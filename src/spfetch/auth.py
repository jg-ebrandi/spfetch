# src/spfetch/auth.py
import msal
import logging
import webbrowser  # <- Nova biblioteca nativa adicionada / New native library added
from abc import ABC, abstractmethod
from .exceptions import AuthenticationError

logger = logging.getLogger("spfetch")

class SharePointAuth(ABC):
    """
    Classe base abstrata para m√©todos de autentica√ß√£o.
    Abstract base class for authentication methods.
    """
    @abstractmethod
    def get_token(self) -> str:
        pass

class DeviceCodeAuth(SharePointAuth):
    """
    Autentica√ß√£o interativa via Device Code (Suporta MFA).
    Interactive authentication via Device Code (Supports MFA).
    """
    def __init__(self, tenant_id: str, client_id: str, scopes: list = None):
        self.tenant_id = tenant_id
        self.client_id = client_id
        self.scopes = scopes or ["https://graph.microsoft.com/Sites.Read.All"]
        self.authority = f"https://login.microsoftonline.com/{tenant_id}"
        self.app = msal.PublicClientApplication(self.client_id, authority=self.authority)
        self._cached_token = None

    def get_token(self) -> str:
        if self._cached_token:
            return self._cached_token

        logger.info("Iniciando fluxo de autentica√ß√£o via Device Code...")
        logger.info("Starting Device Code authentication flow...")
        
        flow = self.app.initiate_device_flow(scopes=self.scopes)
        if "user_code" not in flow:
            logger.error("Falha ao criar o fluxo de dispositivo.")
            logger.error("Failed to create device flow.")
            raise AuthenticationError("Falha ao criar o fluxo de dispositivo. / Failed to create device flow.")

        # Extra√≠mos o link e o c√≥digo gerados pela Microsoft
        # We extract the link and code generated by Microsoft
        url_login = flow.get("verification_uri", "https://microsoft.com/devicelogin")
        codigo_usuario = flow.get("user_code")

        print(f"\n[A√á√ÉO NECESS√ÅRIA / ACTION REQUIRED]: {flow['message']}")
        print(f"======================================================")
        print(f"üëâ C√ìDIGO / CODE: {codigo_usuario}")
        print(f"======================================================\n")
        
        # Tenta abrir o navegador automaticamente
        # Attempts to open the browser automatically
        try:
            logger.info("Abrindo o navegador padr√£o automaticamente...")
            logger.info("Opening the default browser automatically...")
            webbrowser.open(url_login)
        except Exception as e:
            logger.debug(f"N√£o foi poss√≠vel abrir o navegador: {e}")
            logger.debug(f"Could not open the browser: {e}")
        
        # Aguarda a aprova√ß√£o do usu√°rio no navegador
        # Waits for the user's approval in the browser
        result = self.app.acquire_token_by_device_flow(flow)
        
        if "access_token" in result:
            logger.info("Autentica√ß√£o conclu√≠da com sucesso!")
            logger.info("Authentication completed successfully!")
            self._cached_token = result["access_token"]
            return self._cached_token
            
        error_msg = result.get('error_description', 'Erro desconhecido / Unknown error')
        logger.error(f"Erro de Autentica√ß√£o: {error_msg}")
        raise AuthenticationError(error_msg)

class ClientSecretAuth(SharePointAuth):
    """
    Autentica√ß√£o silenciosa via Client Secret (Service Principal).
    Silent authentication via Client Secret (Service Principal).
    """
    def __init__(self, tenant_id: str, client_id: str, client_secret: str, scopes: list = None):
        self.tenant_id = tenant_id
        self.client_id = client_id
        self.client_secret = client_secret
        self.scopes = scopes or ["https://graph.microsoft.com/.default"]
        self.authority = f"https://login.microsoftonline.com/{tenant_id}"
        self.app = msal.ConfidentialClientApplication(
            self.client_id, 
            authority=self.authority,
            client_credential=self.client_secret
        )
        self._cached_token = None

    def get_token(self) -> str:
        if self._cached_token:
            return self._cached_token

        logger.debug("Obtendo token via Client Secret...")
        result = self.app.acquire_token_for_client(scopes=self.scopes)
        
        if "access_token" in result:
            logger.debug("Token obtido com sucesso!")
            self._cached_token = result["access_token"]
            return self._cached_token
            
        error_msg = result.get('error_description', 'Erro desconhecido / Unknown error')
        logger.error(f"Erro de Autentica√ß√£o (Client Secret): {error_msg}")
        raise AuthenticationError(error_msg)